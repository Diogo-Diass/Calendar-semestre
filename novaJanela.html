<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flatpickr Multiple and Range</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .flatpickr-calendar .custom-button {
            margin: 5px;
            padding: 5px 10px;
            background-color: #007BFF;
            color: #FFF;
            border: none;
            cursor: pointer;
        }

        .span-datas{
            background-color: #780000;
            color: white;
            padding: 5px;
            box-sizing: border-box;
            /* margin-top: 0em; */
            position: relative;
            top: 1em;
            margin-right: 1em;
            border-radius: 5px;
        }
        .flatpickr-calendar .active-button {
            background-color: #FF0000;  /* Red color for active button */
        }
    </style>
</head>
<body>

<input type="text" id="datePicker">
<div id="savedRanges"></div> <!-- Div para exibir os ranges salvos -->

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    let datePicker = document.getElementById('datePicker');
    let flatpickrInstance;
    let mode = 'range';  // Variável para armazenar o modo atual
    window.listaDatas = []; // Array para armazenar os ranges salvos

    function initializeFlatpickr(shouldOpen = false) {
        if (flatpickrInstance) {
            flatpickrInstance.destroy();
        }

        flatpickrInstance = flatpickr(datePicker, {
            mode: mode,
            dateFormat: "d/m/Y",
            onReady: function(selectedDates, dateStr, instance) {
                let multipleButton = document.createElement('button');
                multipleButton.innerText = 'Multiple';
                multipleButton.classList.add('custom-button');
                multipleButton.addEventListener('click', function() {
                    mode = 'multiple';
                    instance.config.mode = mode;
                    instance.redraw();
                    initializeFlatpickr(true);
                });

                let rangeButton = document.createElement('button');
                rangeButton.innerText = 'Range';
                rangeButton.classList.add('custom-button');
                rangeButton.addEventListener('click', function() {
                    mode = 'range';
                    instance.config.mode = mode;
                    instance.redraw();
                    initializeFlatpickr(true);
                });

                instance.calendarContainer.appendChild(multipleButton);
                instance.calendarContainer.appendChild(rangeButton);

                // Set active button
                if (mode === 'multiple') {
                    multipleButton.classList.add('active-button');
                } else {
                    rangeButton.classList.add('active-button');
                }

                // Add save button for range mode
                if (mode === 'range') {
                    let saveButton = document.createElement('button');
                    saveButton.innerText = 'Save Range';
                    saveButton.classList.add('custom-button');

                    saveButton.addEventListener('click', function() {
                        let div = document.createElement("div");
                        let span = document.createElement("span");
                        let button = document.createElement("button");

                        button.innerHTML = "x";
                        span.classList.add("span-datas");
                        button.classList.add("span-datas");

                        window.listaDatas.push([...window.currentRange]);

                        span.innerHTML = window.currentFormattedRange[0] + " até " + window.currentFormattedRange[window.currentFormattedRange.length - 1];

                        div.appendChild(button);
                        div.appendChild(span);
                        div.setAttribute("data-index", window.listaDatas.length - 1); // Adiciona o índice como um atributo de dados
                        document.getElementById("savedRanges").appendChild(div);

                        button.addEventListener("click", function(){
                            let index = parseInt(div.getAttribute("data-index"));
                            div.remove();
                            window.listaDatas.splice(index, 1);  // Remove o range do array

                            // Atualiza os índices dos elementos restantes
                            let ranges = document.getElementById("savedRanges").children;
                            for (let i = 0; i < ranges.length; i++) {
                                ranges[i].setAttribute("data-index", i);
                            }
                        });
                    });

                    instance.calendarContainer.appendChild(saveButton);
                }

                if (shouldOpen) {
                    instance.open();
                }
            },
            onChange: function(selectedDates, dateStr, instance) {
                let inicio = selectedDates[0];
                let end = selectedDates[1];
                let array = [];
                let dataFormatArray = [];

                while(inicio <= end){
                    setTimeout(() => {
                        instance.open()
                    }, 0);
                    let dia = inicio.getDate();
                    let mes = inicio.getMonth() + 1;
                    let ano = inicio.getFullYear();
                  
                    let dataCompleta = ano + (mes < 10 ? '0' : '') + mes + (dia < 10 ? '0' : '') + dia;
                    let dataFormat = (dia < 10 ? '0' : '') + dia + "/" + (mes < 10 ? '0' : '') + mes +"/" + ano;

                    array.push(dataCompleta);
                    dataFormatArray.push(dataFormat);
                    inicio.setDate(inicio.getDate() + 1);
                }

                window.currentRange = array;
                window.currentFormattedRange = dataFormatArray;

                if (shouldOpen) {
                    instance.open();
                }
            }
        });

        if (shouldOpen) {
            flatpickrInstance.open();
        }
    }

    // Inicializa o Flatpickr
    initializeFlatpickr();
</script>

</body>
</html>
